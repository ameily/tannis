<dom-module id='device-card'>
  <template>
    <style>
      .card-content.expandable {
        cursor: pointer;
      }

      .company-tag {
        font-size: 100%;
        font-family: monospace;
      }

      .monospace {
        font-family: monospace;
      }
    </style>


    <div class='card card-default' style$="{{getCardStyle(device)}}">
      <div class$='card-content {{getHeadingClass(device)}}' on-tap="toggle" style$="{{getHeadingStyle(device)}}">
        <h3 class='card-title'>
          {{device.name}}
        </h3>
        <div hidden$="{{!owner}}">
          <a href$="{{getOwnerUrl(owner)}}">@{{owner}}</a>
        </div>
      </div>
      <div id='device-details' style='display: none'>
        <!--<div class='card-content text-right'>
          <div class='btn-group btn-group-xs'>
            <a class='btn btn-danger' on-tap="{{unassign}}" href='javascript:void(0)'>
              <span class='glyphicon glyphicon-remove-sign'></span>
              Unassign
            </a>
          </div>
        </div>-->

        <!-- Device fields (mac address, manufacturer, etc.) -->
        <table class='table table-hover' hidden$="{{!hasFields(device)}}">
          <tbody>
            <template is='dom-if' if="{{device.macAddress}}">
              <tr>
                <th>MAC Address</th>
                <td><span class='monospace'>{{device.macAddress}}</span></td>
              </tr>
            </template>
            <template is="dom-if" if="{{device.manufacturer}}">
              <tr>
                <th>Model</th>
                <td>{{device.manufacturer}} {{device.modelNumber}}</td>
              </tr>
            </template>
            <template is='dom-if' if='{{device.serialNumber}}'>
              <tr>
                <th>Serial Number</th>
                <td><span class='monospace'>{{device.serialNumber}}</span></td>
              </tr>
            </template>
            <template is='dom-if' if="{{device.companyTag}}">
              <tr>
                <th>Company Tag</th>
                <td><span class='label label-default company-tag'>{{device.companyTag}}</span></td>
              </tr>
            </template>

            <template is='dom-repeat' items="{{device.customFields}}">
              <!-- Custom fields -->
              <tr>
                <th>{{item.name}}</th>
                <td>{{item.value}}</td>
              </tr>
            </template>
          </tbody>
        </table>

        <template is='dom-if' if="{{device.isContainer}}">
          <div class='card-divider' hidden$='{{!hasFields(device)}}'></div>
          <div class='card-content card-container'>
            <!-- Child Devices -->
            <h3 class='card-title' style='margin-bottom: 20px;'>Child Devices</h3>

            <div class='text-center'>
              <paper-spinner active="{{loading}}" hidden$="{{!loading}}"></paper-spinner>
            </div>

            <template is='dom-repeat' items="{{childDevices}}">
              <device-card device="{{item}}" owner="{{owner}}"></device-card>
            </template>
            <button class='btn btn-block btn-default btn-lg' on-tap="{{addChildDevice}}">
              <span class='glyphicon glyphicon-plus-sign'></span>
              Add Child Device
            </button>
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'device-card',
      properties: {
        device: Object,
        active: Boolean,
        owner: {
          type: Object,
          value: null
        },
        childDevices: {
          type: Array,
          value: function() {
            return [];
          }
        },
        loading: Boolean
      },

      getOwnerUrl: function(owner) {
        return owner ? "/users/" + owner.id : "javascript:void(0)";
      },

      getHeadingClass: function(device) {
        return this.hasFields(device) || (device && device.isContainer) ? "expandable" : "";
      },

      toggle: function() {
        var device = this.get('device');
        if(!this.hasFields(device)) {
          return;
        }

        var isActive = this.get('active');
        if(isActive) {
          $(this.$['device-details']).slideUp();
        } else {
          var self = this;

          this.set('childDevices', []);
          this.set('loading', true);

          $(this.$['device-details']).slideDown(400, function() {
            self.loadChildDevices();
          });
          //this.loadChildDevices();
        }

        this.set('active', !isActive);
      },

      loadChildDevices: function() {
        var self = this;
        var url = "/api/v1/devices/" + this.get('device')._id + "/children";

        $.ajax(url, {
          success: function(data) {
            //self.set('childDevices', data);
            data.forEach(function(device) {
              self.push('childDevices', device);
            });
          },

          complete: function() {
            self.set('loading', false);
          }
        });
      },

      hasFields: function(device) {
        if(device) {
          var x = (!!device.macAddress || !!device.serialNumber ||
                  !!device.manufacturer || !!device.modelNumber ||
                  !!device.companyTag || !!device.customFields.length);
          return x;
        } else {
          return false;
        }
      },

      hasDetails: function(device) {
        return this.hasFields(device) && device.isContainer;
      },

      getCardStyle: function(device) {
        var style = "";
        if(device.bgColor) {
          style = "border: 2px solid " + device.bgColor;
        }
        return style;
      },

      getHeadingStyle: function(device) {
        var style = "";
        if(device.fgColor) {
          style += "color: " + device.fgColor + ';';
        }

        if(device.bgColor) {
          style += "background-color: " + device.bgColor + ';';
        }

        return style;
      },

      addChildDevice: function() {
      }
    })
  </script>
</dom-module>